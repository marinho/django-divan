<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
<title>Divan</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5196 2007-06-03 20:25:28Z wiemann $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="divan">
<h1 class="title">Divan</h1>

<p>Divan is an application that combines some of the best features of Django
(the forms library, the admin, and the template language) with the flexibility
of CouchDB.  It works something like this:</p>
<ol class="arabic simple">
<li>You subclass the <tt class="docutils literal"><span class="pre">BaseOption</span></tt> model provided by <tt class="docutils literal"><span class="pre">divan.models</span></tt>.</li>
<li>You register your subclass with the Django admin application.</li>
<li>You, or your users, use this subclass to create &quot;fields&quot; that are mapped to keys
in CouchDB documents.</li>
<li>You subclass the <tt class="docutils literal"><span class="pre">CouchForm</span></tt> class provided by <tt class="docutils literal"><span class="pre">divan.forms</span></tt>, with a special
declaration that ties it to your <tt class="docutils literal"><span class="pre">BaseOption</span></tt> subclass.</li>
<li>Your form class will now have all of the fields that you create in the admin, and
you get a CouchDB document when you call <tt class="docutils literal"><span class="pre">form.save()</span></tt>.</li>
</ol>
<div class="section" id="dependencies">
<h1>Dependencies</h1>
<p>Naturally, Divan requires that you have CouchDB 0.9.x installed (and running).</p>
<p>It also requires the <a class="reference external" href="http://code.google.com/p/couchdb-python/">couchdb-python</a> library.</p>
<p>If you want to be able to create form fields that use TinyMCE, you also should
install <a class="reference external" href="http://code.google.com/p/django-tinymce/">django-tinymce</a>.</p>
</div>
<div class="section" id="installation">
<h1>Installation</h1>
<p>Clone the git repository:</p>
<pre class="literal-block">
git clone git://github.com/olifantworkshop/django_divan.git
</pre>
<p>Put the django_divan/divan folder somewhere on your PYTHONPATH and add 'divan'
to the INSTALLED_APPS in your settings module.</p>
</div>
<div class="section" id="getting-started">
<h1>Getting started</h1>
<p>Start CouchDB on either the default port locally (5984) or an address defined by
<tt class="docutils literal"><span class="pre">DEFAULT_COUCH_SERVER</span></tt> in your Django settings module.</p>
<div class="section" id="defining-fields">
<h2>Defining fields</h2>
<p>Divan provides an abstract model class <tt class="docutils literal"><span class="pre">BaseOption</span></tt> that applications
extend and use to define the fields that will appear in a form/&quot;model&quot;
instance.  This also includes an inner <tt class="docutils literal"><span class="pre">Divan</span></tt> class:</p>
<pre class="literal-block">
class FooOption(BaseOption):
    class Divan:
        database = 'foo'
</pre>
<p><tt class="docutils literal"><span class="pre">BaseOption</span></tt> includes the following fields:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">field_name</span></tt></dt>
<dd>The human readable name of the field.  Used as the argument to the
<tt class="docutils literal"><span class="pre">label</span></tt> parameter of the field constructor.</dd>
<dt><tt class="docutils literal"><span class="pre">field_type</span></tt></dt>
<dd>User-friendly names that map to one of the <tt class="docutils literal"><span class="pre">Field</span></tt> subclasses in
<tt class="docutils literal"><span class="pre">django.forms.fields</span></tt>.  See <a class="reference internal" href="#supported-field-types">Supported field types</a>.</dd>
<dt><tt class="docutils literal"><span class="pre">group</span></tt></dt>
<dd>String to tag groups of fields.  A future release will include JavaScript
for auto-completing to ensure consistency across instances.</dd>
<dt><tt class="docutils literal"><span class="pre">key</span></tt></dt>
<dd>Auto-generated value from <tt class="docutils literal"><span class="pre">field_name</span></tt>, lower-casing the string and
replacing non-alphanumeric characters with underscores.  When form classes
are created, the field will be accessible as an attribute with this name.</dd>
<dt><tt class="docutils literal"><span class="pre">required</span></tt></dt>
<dd>Determines whether or not the field will be required in forms.</dd>
<dt><tt class="docutils literal"><span class="pre">order</span></tt></dt>
<dd>Secondary sort condition after <tt class="docutils literal"><span class="pre">group</span></tt>.  This is currently useless.  A
future release will include JavaScript for drag &amp; drop sorting of Option
instances in the Django admin.</dd>
</dl>
<p>The inner <tt class="docutils literal"><span class="pre">Divan</span></tt> class can declare a <tt class="docutils literal"><span class="pre">database</span></tt> attribute, set to the name
of the CouchDB database in which the objects will be created.  If this class is
not defined, Divan will look for <tt class="docutils literal"><span class="pre">settings.DEFAULT_COUCH_DATABASE</span></tt>, and
otherwise throw an error.</p>
<p>The <tt class="docutils literal"><span class="pre">Divan</span></tt> class can also declare a <tt class="docutils literal"><span class="pre">choice_related_name</span></tt> attribute for
handling multiple choice questions, as explained below.</p>
</div>
<div class="section" id="dealing-with-multiple-choice-fields">
<h2>Dealing with multiple choice fields</h2>
<p>If you need to support multiple choice fields, you'll have to subclass
<tt class="docutils literal"><span class="pre">divan.models.OptionChoice</span></tt> and add another declaration to the <tt class="docutils literal"><span class="pre">Divan</span></tt>
inner class of your <tt class="docutils literal"><span class="pre">BaseOption</span></tt> subclass.</p>
<pre class="literal-block">
class FooOption(BaseOption):
    class Divan:
        database = 'foo'
        choice_related_name = 'bar_set'

class Bar(OptionChoice):
    option = models.ForeignKey(FooOption)
</pre>
<p>The name of the foreign key field on <tt class="docutils literal"><span class="pre">Bar</span></tt> does not matter.  What does matter
is that the <tt class="docutils literal"><span class="pre">choice_related_name</span></tt> declaration matches the name of the related
manager for that object.</p>
</div>
<div class="section" id="supported-field-types">
<h2>Supported field types</h2>
<p>The following basic field types are supported and provide the expected validation:</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">forms.CharField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.IntegerField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.FloatField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.DateField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.TimeField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.DateTimeField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.EmailField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.FileField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.ImageField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.URLField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.BooleanField</span></tt></li>
<li><tt class="docutils literal"><span class="pre">forms.IPAddressField</span></tt></li>
</ul>
</blockquote>
<p>Additionally, <tt class="docutils literal"><span class="pre">forms.ChoiceField</span></tt> and <tt class="docutils literal"><span class="pre">forms.MultipleChoiceField</span></tt> are
available as input methods.  Important to note, however, is that any
<a class="reference internal" href="#serialization">serialization</a> methods from the field type selected will be applied to each
selected choice.</p>
</div>
<div class="section" id="forms-for-the-user-defined-fields">
<h2>Forms for the user-defined fields</h2>
<p>Subclasses of the <tt class="docutils literal"><span class="pre">CouchForm</span></tt> class provided in <tt class="docutils literal"><span class="pre">divan.forms</span></tt> declare a
couple of attributes that provide the bridge between CouchDB and the SQL
database:</p>
<pre class="literal-block">
class FooForm(CouchForm):
    class Divan:
        model = FooOption
        groups = ['address data']
</pre>
<p>The fields added to the form will be filtered by the <tt class="docutils literal"><span class="pre">FooOption.group</span></tt>
strings that are declared as a list on the <tt class="docutils literal"><span class="pre">group</span></tt> attribute of <tt class="docutils literal"><span class="pre">Divan</span></tt>.
If <tt class="docutils literal"><span class="pre">group</span></tt> is not defined, a field will be created for every instance of
<tt class="docutils literal"><span class="pre">model</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">CouchForm</span></tt> subclasses inherit from <tt class="docutils literal"><span class="pre">BaseForm</span></tt> with a different metaclass,
so they have all of the goodies you expect from a Django <tt class="docutils literal"><span class="pre">Form</span></tt> subclass,
including <tt class="docutils literal"><span class="pre">is_valid()</span></tt>, <tt class="docutils literal"><span class="pre">is_bound</span></tt>, <tt class="docutils literal"><span class="pre">initial</span></tt>, etc.</p>
<p>They can also be instantiated with an additional keyword argument <tt class="docutils literal"><span class="pre">document</span></tt>,
which should be a <tt class="docutils literal"><span class="pre">Document</span></tt> object as retrieved from CouchDB by the Python
client library.</p>
<p>Like <tt class="docutils literal"><span class="pre">ModelForm</span></tt> subclasses, <tt class="docutils literal"><span class="pre">CouchForm</span></tt> subclasses have a <tt class="docutils literal"><span class="pre">save()</span></tt>
method.  If the given instance was instantiated with an argument to the
<tt class="docutils literal"><span class="pre">document</span></tt> parameter, it will update the document in question; otherwise, it
will create a new one.  <tt class="docutils literal"><span class="pre">save()</span></tt> returns the new or updated document.</p>
</div>
<div class="section" id="couchmodel">
<h2><tt class="docutils literal"><span class="pre">CouchModel</span></tt></h2>
<p>Divan provides a wrapper class called <tt class="docutils literal"><span class="pre">CouchModel</span></tt> that makes it easier to
deal with CouchDB documents in templates.  It does not provide database write
capabilities. It simply gives template authors a few convenient accessors.</p>
<p><tt class="docutils literal"><span class="pre">CouchModel</span></tt> is subclassed like so:</p>
<pre class="literal-block">
class Foo(CouchModel):
    class Divan:
        schema = FooOption
</pre>
<p>Now we instantiate <tt class="docutils literal"><span class="pre">Foo</span></tt> with the id of a CouchDB document:</p>
<pre class="literal-block">
foo = Foo(document_id='bar')
</pre>
<p>The resulting instance will have attributes corresponding to each instance of
<tt class="docutils literal"><span class="pre">FooOption</span></tt> that you have created, accessible by their respective <tt class="docutils literal"><span class="pre">key</span></tt>
values. Any other keys that happen to be in the document will not be added to
the object.</p>
<p>You can also iterate over the <tt class="docutils literal"><span class="pre">CouchModel</span></tt>:</p>
<pre class="literal-block">
for field in foo:
    print field.label, field
</pre>
<p><tt class="docutils literal"><span class="pre">Foo</span></tt> will also have a dictionary of fields grouped by the <tt class="docutils literal"><span class="pre">group</span></tt>
attribute of <tt class="docutils literal"><span class="pre">FooOption</span></tt>, which is aptly named <tt class="docutils literal"><span class="pre">groups</span></tt>.  This allows you to
display large documents in a structured manner in the templates.</p>
<pre class="literal-block">
{% for title, fieldset in document.groups.items %}
    &lt;h3&gt;{{ title }}&lt;/h3&gt;
    {% for field in fieldset %}
        &lt;p&gt;{{ field.label }}: {{ field }}&lt;/p&gt;
    {% endfor %}
{% endfor %}
</pre>
</div>
<div class="section" id="serialization">
<h2>Serialization</h2>
<p>Any of the supported field types may have default serializer/deserializer
functions declared on <tt class="docutils literal"><span class="pre">CouchForm</span></tt> or <tt class="docutils literal"><span class="pre">CouchModel</span></tt> subclasses.  For example,
you might want to pad <tt class="docutils literal"><span class="pre">IntegerField</span></tt> values with leading zeros if you are
using Lucene to drive search over CouchDB documents:</p>
<pre class="literal-block">
class FooForm(CouchForm):
    class Divan:
        model = FooOption
        IntegerField = {
            'serialize': lambda i: '%015d' % i,
            'deserialize': lambda s: int(s)
        }
</pre>
<p><tt class="docutils literal"><span class="pre">DateField</span></tt>, <tt class="docutils literal"><span class="pre">DateTimeField</span></tt>, and <tt class="docutils literal"><span class="pre">TimeField</span></tt> values are by default
serialized to ISO-8601 timestamps.  This behavior can be overridden as desired.</p>
</div>
</div>
</div>
</body>
</html>
